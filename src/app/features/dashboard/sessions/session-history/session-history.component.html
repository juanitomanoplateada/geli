<div class="history-container">
  <!-- 🔍 Barra de búsqueda principal -->
  <div class="search-bar">
    <input
      type="text"
      appUppercase
      [(ngModel)]="searchQuery"
      (keyup)="onKeyUp($event)"
      [disabled]="isLoading"
      class="search-input"
      placeholder="Buscar por laboratorio o equipo..."
    />

    <button class="search-button" (click)="onSearch()" [disabled]="isLoading">
      🔍 <span *ngIf="!isLoading">Buscar</span>
      <span *ngIf="isLoading">Buscando...</span>
    </button>

    <button
      class="advanced-search-btn"
      (click)="toggleAdvancedSearch()"
      [disabled]="isLoading"
    >
      {{ showAdvancedSearch ? "Ocultar filtros" : "Búsqueda avanzada" }}
    </button>
  </div>

  <!-- 🎯 Filtros avanzados -->
  <div *ngIf="showAdvancedSearch" class="advanced-search">
    <!-- Fechas y horas -->
    <div class="filter-group">
      <label for="dateFrom">Fecha desde:</label>
      <input
        id="dateFrom"
        type="date"
        [(ngModel)]="filters.dateFrom"
        (change)="onSearch()"
        title="Seleccione la fecha inicial"
      />
    </div>

    <div class="filter-group">
      <label for="dateTo">Fecha hasta:</label>
      <input
        id="dateTo"
        type="date"
        [(ngModel)]="filters.dateTo"
        (change)="onSearch()"
        title="Seleccione la fecha final"
      />
    </div>

    <div class="filter-group">
      <label for="timeFrom">Hora desde:</label>
      <input
        id="timeFrom"
        type="time"
        [(ngModel)]="filters.timeFrom"
        (change)="onSearch()"
        title="Seleccione la hora inicial"
      />
    </div>

    <div class="filter-group">
      <label for="timeTo">Hora hasta:</label>
      <input
        id="timeTo"
        type="time"
        [(ngModel)]="filters.timeTo"
        (change)="onSearch()"
        title="Seleccione la hora final"
      />
    </div>

    <!-- Dropdowns personalizados -->
    <div class="filter-group">
      <label>Laboratorio:</label>
      <app-dropdown-filter
        [options]="availableLabs"
        [selected]="filters.lab"
        (selectedChange)="filters.lab = $event; onSearch()"
        [placeholder]="'Laboratorio'"
        [allowEmpty]="'Todos'"
      ></app-dropdown-filter>
    </div>

    <div class="filter-group">
      <label>Equipo / Patrón:</label>
      <app-dropdown-filter
        [options]="availableEquipments"
        [selected]="filters.equipment"
        (selectedChange)="filters.equipment = $event; onSearch()"
        [placeholder]="'Equipo / Patrón'"
        [allowEmpty]="'Todos'"
      ></app-dropdown-filter>
    </div>

    <!-- Estados -->
    <div class="filter-group">
      <label for="verifiedFilter">Estado - Verificado:</label>
      <select
        id="verifiedFilter"
        [(ngModel)]="filters.verifiedStatus"
        (change)="onSearch()"
        title="Seleccione el estado de verificación"
      >
        <option value="">Todos</option>
        <option value="SI">Sí</option>
        <option value="NO">No</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="usageFilter">Estado - Para uso:</label>
      <select
        id="usageFilter"
        [(ngModel)]="filters.usageStatus"
        (change)="onSearch()"
        title="Seleccione disponibilidad de uso"
      >
        <option value="">Todos</option>
        <option value="Disponible">Disponible</option>
        <option value="No disponible">No disponible</option>
      </select>
    </div>

    <!-- Rango de tiempo de uso -->
    <div class="filter-group">
      <label for="durationMin">Tiempo de uso desde (min):</label>
      <input
        id="durationMin"
        type="number"
        appIntegerOnly
        [(ngModel)]="filters.usageDurationMin"
        (change)="onSearch()"
        placeholder="Mínimo"
        title="Tiempo mínimo en minutos"
        min="0"
      />
    </div>

    <div class="filter-group">
      <label for="durationMax">Tiempo de uso hasta (min):</label>
      <input
        id="durationMax"
        type="number"
        appIntegerOnly
        [(ngModel)]="filters.usageDurationMax"
        (change)="onSearch()"
        placeholder="Máximo"
        title="Tiempo máximo en minutos"
        min="0"
      />
    </div>

    <!-- Rango de muestras -->
    <div class="filter-group">
      <label for="sampleCountMin">Muestras desde:</label>
      <input
        id="sampleCountMin"
        type="number"
        appIntegerOnly
        [(ngModel)]="filters.sampleCountMin"
        (change)="onSearch()"
        placeholder="Mínimo"
        title="Cantidad mínima de muestras"
        min="0"
      />
    </div>

    <div class="filter-group">
      <label for="sampleCountMax">Muestras hasta:</label>
      <input
        id="sampleCountMax"
        type="number"
        appIntegerOnly
        [(ngModel)]="filters.sampleCountMax"
        (change)="onSearch()"
        placeholder="Máximo"
        title="Cantidad máxima de muestras"
        min="0"
      />
    </div>

    <!-- Función -->
    <div class="filter-group">
      <label>Función utilizada:</label>
      <app-dropdown-filter
        [options]="availableFunctions"
        [selected]="filters.function"
        (selectedChange)="filters.function = $event; onSearch()"
        [placeholder]="'Función'"
        [allowEmpty]="'Todas'"
      ></app-dropdown-filter>
    </div>

    <!-- Responsable -->
    <div class="filter-group">
      <label>Responsable:</label>
      <app-dropdown-filter
        [options]="availableUsers"
        [selected]="filters.user"
        (selectedChange)="filters.user = $event; onSearch()"
        [placeholder]="'Responsable'"
        [allowEmpty]="'Todos'"
      ></app-dropdown-filter>
    </div>

    <!-- Botón limpiar -->
    <div class="filter-group">
      <label>&nbsp;</label>
      <button class="clear-filters-btn" (click)="clearFilters()">
        Limpiar filtros
      </button>
    </div>
  </div>

  <!-- 🗂 Orden por fecha -->
  <div class="sort-bar">
    <label>Ordenar por fecha:</label>
    <button (click)="sortAscending = !sortAscending">
      {{ sortAscending ? "⬇️ Más antiguo" : "⬇️ Más reciente" }}
    </button>
  </div>

  <!-- 📄 Resultados -->
  <div class="history-content">
    <aside class="history-sidebar">
      <div
        class="session-preview"
        *ngFor="let session of filteredSessions"
        (click)="selectSession(session)"
        [class.active]="session === selectedSession"
      >
        <h4>{{ session.lab }}</h4>
        <p>{{ session.equipment }}</p>
        <span>{{ session.date }} - {{ session.time }}</span>
      </div>

      <div
        class="no-results"
        *ngIf="filteredSessions.length === 0 && !isLoading"
      >
        No se encontraron sesiones para mostrar.
      </div>
    </aside>

    <!-- 📋 Detalle de la sesión -->
    <section class="history-detail" *ngIf="selectedSession">
      <h2>Detalles de la Sesión</h2>
      <p>
        <strong>Marca Temporal:</strong> {{ selectedSession.date | uppercase }}
        {{ selectedSession.time }}
      </p>
      <p><strong>Laboratorio:</strong> {{ selectedSession.lab | uppercase }}</p>
      <p>
        <strong>Equipo / Patrón:</strong>
        {{ selectedSession.equipment | uppercase }}
      </p>
      <p>
        <strong>Estado - Verificado:</strong>
        {{ selectedSession.verifiedStatus | uppercase }}
      </p>
      <p>
        <strong>Responsable:</strong>
        {{ selectedSession.responsible | uppercase }}
      </p>
      <p>
        <strong>Correo Electrónico:</strong>
        {{ selectedSession.email | uppercase }}
      </p>
      <p>
        <strong>Estado - Para uso:</strong>
        {{ selectedSession.usageStatus | uppercase }}
      </p>

      <p>
        <strong>Tiempo de uso:</strong>
        <span
          *ngIf="selectedSession.usageDuration !== undefined; else noDuration"
        >
          {{ selectedSession.usageDuration }} MINUTOS
        </span>
        <ng-template #noDuration>N/A</ng-template>
      </p>

      <p>
        <strong>Cantidad de muestras:</strong>
        <span *ngIf="selectedSession.sampleCount !== undefined; else noSamples">
          {{ selectedSession.sampleCount }}
        </span>
        <ng-template #noSamples>N/A</ng-template>
      </p>

      <p>
        <strong>Funciones utilizadas:</strong>
        <ng-container
          *ngIf="
            selectedSession.functionsUsed &&
              selectedSession.functionsUsed.length > 0;
            else noFunctions
          "
        >
          {{ selectedSession.functionsUsed.join(", ") | uppercase }}
        </ng-container>
        <ng-template #noFunctions>NO APLICA</ng-template>
      </p>

      <p>
        <strong>Observaciones:</strong>
        <ng-container *ngIf="selectedSession.observations; else noObs">
          {{ selectedSession.observations | uppercase }}
        </ng-container>
        <ng-template #noObs>N/A</ng-template>
      </p>
    </section>
  </div>
</div>
