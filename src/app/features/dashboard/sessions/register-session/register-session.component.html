<div *ngIf="isLoading" class="spinner-wrapper">
  <div class="spinner"></div>
  <p>Cargando datos, por favor espera...</p>
</div>

<div *ngIf="!isLoading" class="session-wrapper">
  <!-- Header: Iniciar nueva sesión -->
  <section class="header-section">
    <h1>Registrar Uso de Equipo / Patrón</h1>

    <div class="dropdown-wrapper">
      <!-- Laboratorio -->
      <div class="dropdown-block">
        <app-dropdown-search-entity-obj
          [placeholder]="'Seleccione el laboratorio en el que se encuentra...'"
          [options]="labOptions"
          [selectedValue]="selectedLabId"
          (select)="onSelectLab($event)"
        ></app-dropdown-search-entity-obj>

        <div
          *ngIf="selectedLabStatus?.active === false"
          class="inactive-warning"
        >
          ⚠️ Este laboratorio está inactivo.<br />
          <strong>Motivo:</strong> {{ selectedLabStatus?.remarks }}
        </div>
      </div>

      <!-- Equipo / Patrón -->
      <div class="dropdown-block">
        <app-dropdown-search-entity-obj
          [placeholder]="'Seleccione el equipo que va a utilizar...'"
          [options]="equipmentOptions"
          [selectedValue]="selectedEquipment"
          [disabled]="
            !selectedLabId ||
            selectedLabStatus?.active === false ||
            isLoadingEquipments
          "
          (select)="onSelectEquipment($event)"
        ></app-dropdown-search-entity-obj>

        <div
          *ngIf="
            selectedEquipmentStatus?.active === false &&
            !hasActiveSessionWithEquipment
          "
          class="inactive-warning"
        >
          ⚠️ Este equipo está inactivo.<br />
          <strong>Motivo:</strong> {{ selectedEquipmentStatus?.remarks }}
        </div>

        <div
          *ngIf="hasActiveSessionWithEquipment"
          class="duplicate-session-warning"
        >
          ⚠️ Ya tienes una sesión activa con este equipo. Finalízala antes de
          iniciar una nueva.
        </div>

        <div
          *ngIf="isEquipmentInUseByAnotherUser"
          class="duplicate-session-warning"
        >
          ⚠️ Este equipo ya está en uso por otro usuario. Espera a que liberen
          la sesión.
        </div>
      </div>
    </div>

    <div *ngIf="isLoadingEquipments" class="spinner-mini">
      <div class="spinner"></div>
      <p>Cargando equipos disponibles...</p>
    </div>

    <button
      class="start-btn"
      [disabled]="
        !selectedLabId ||
        !selectedEquipment ||
        selectedLabStatus?.active === false ||
        selectedEquipmentStatus?.active === false ||
        hasActiveSessionWithEquipment ||
        isEquipmentInUseByAnotherUser
      "
      (click)="onStartSessionClick()"
    >
      Iniciar Sesión
    </button>

    <!-- Modal Confirmar Inicio -->
    <app-confirm-modal
      [title]="'¿Iniciar sesión con este equipo?'"
      [show]="showConfirmationModal"
      [confirmLabel]="'Confirmar'"
      [isLoading]="isStartingSession"
      (confirm)="confirmStartSession()"
      (cancel)="cancelStartSession()"
    >
      <div class="summary-section">
        <p><strong>Laboratorio:</strong> {{ getLabLabel(selectedLabId) }}</p>
        <p>
          <strong>Equipo:</strong> {{ getEquipmentLabel(selectedEquipment) }}
        </p>
        <p><strong>Responsable:</strong> {{ currentUserName }}</p>
      </div>

      <div *ngIf="startSessionSuccess" class="feedback success">
        ✅ Sesión iniciada exitosamente.
      </div>
      <div *ngIf="startSessionError" class="feedback error">
        ❌ Error al iniciar la sesión. Intenta nuevamente.
      </div>
    </app-confirm-modal>
  </section>
</div>
