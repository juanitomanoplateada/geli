<div class="session-container">
  <div class="session-header">
    <div class="session-row">
      <h1>REGISTRAR USO DE EQUIPO / PATRÓN</h1>

      <!-- LAB SELECTOR -->
      <div class="dropdown-select">
        <div class="select-box" (click)="toggleLabDropdown()">
          {{ selectedLab || "Seleccione un laboratorio" }}
        </div>
        <div class="dropdown" *ngIf="showLabDropdown">
          <input
            type="text"
            [(ngModel)]="labSearch"
            placeholder="Buscar laboratorio..."
          />
          <div class="options">
            <div
              class="option"
              *ngFor="let lab of filteredLabs"
              (click)="selectLab(lab)"
            >
              {{ lab.name }}
            </div>
          </div>
        </div>
      </div>

      <!-- EQUIPMENT SELECTOR -->
      <div class="dropdown-select" [class.disabled]="!selectedLab">
        <div
          class="select-box"
          (click)="toggleEquipmentDropdown()"
          [class.disabled]="!selectedLab"
        >
          {{ selectedEquipment || "Seleccione un equipo / patrón" }}
        </div>
        <div class="dropdown" *ngIf="showEquipmentDropdown && selectedLab">
          <input
            type="text"
            [(ngModel)]="equipmentSearch"
            placeholder="Buscar equipo / patrón..."
          />
          <div class="options">
            <div
              class="option"
              *ngFor="let equip of filteredEquipments"
              (click)="selectEquipment(equip)"
            >
              {{ equip }}
            </div>
          </div>
        </div>
      </div>

      <!-- START BUTTON -->
      <button
        class="primary-btn"
        [disabled]="!selectedLab || !selectedEquipment"
        (click)="startSession()"
      >
        Registrar Uso
      </button>
    </div>
  </div>

  <div class="session-body">
    <!-- LEFT PANEL -->
    <div class="checkin-panel" *ngIf="sessionStarted">
      <h3>Registro de Entrada</h3>

      <div class="info-item">
        <label>Fecha:</label>
        <span>{{ checkIn.date }}</span>
      </div>

      <div class="info-item">
        <label>Hora:</label>
        <span>{{ checkIn.time }}</span>
      </div>

      <div class="info-item">
        <label>Laboratorio:</label>
        <span>{{ selectedLab }}</span>
      </div>

      <div class="info-item">
        <label>Equipo / Patrón:</label>
        <span>{{ selectedEquipment }}</span>
      </div>

      <div class="info-item">
        <label>Estado - Verificado:</label>
        <span>YES</span>
      </div>

      <div class="info-item">
        <label>Responsable a cargo:</label>
        <span>RAAA</span>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="checkout-panel" *ngIf="sessionStarted">
      <h3>Registro de Salida</h3>

      <label>
        Estado - Para uso:
        <select
          [(ngModel)]="availabilityStatus"
          (change)="onAvailabilityChange(selectRef.value)"
          #selectRef
          class="styled-select"
        >
          <option value="">Seleccione una opción</option>
          <option value="Yes">SI</option>
          <option value="No">NO</option>
        </select>
      </label>

      <ng-container *ngIf="availabilityStatus">
        <ng-container *ngIf="availabilityStatus === 'No'">
          <div class="alert-box">
            Si la respuesta es negativa por favor incluya en las observaciones
            los motivos por el cual el equipo de medición no está disponible
            para uso.
          </div>
        </ng-container>

        <label>
          Condiciones de uso - Tiempo de uso:
          <input type="text" [value]="usageDuration" readonly />
        </label>

        <label>
          Condiciones de uso - Cantidad de muestras analizadas:
          <input type="number" [(ngModel)]="checkOut.sampleCount" />
        </label>

        <label>Condiciones de uso - Funciones utilizadas:</label>

        <div class="functions-container">
          <div class="dropdown-select">
            <div class="select-box" (click)="toggleFunctionDropdown()">
              Seleccione las funciones
            </div>
            <div class="dropdown" *ngIf="showFunctionDropdown">
              <input
                type="text"
                [(ngModel)]="functionSearch"
                placeholder="Buscar función..."
              />
              <div class="options">
                <div
                  class="option"
                  *ngFor="let func of filteredFunctions"
                  (click)="selectFunction(func)"
                >
                  {{ func }}
                </div>
              </div>
            </div>
          </div>

          <div class="function-tags">
            <span class="tag" *ngFor="let func of selectedFunctions">
              {{ func }}
              <button class="remove-tag" (click)="removeFunction(func)">
                ×
              </button>
            </span>
          </div>
        </div>

        <label>
          Observaciones:
          <textarea [(ngModel)]="checkOut.remarks"></textarea>
        </label>
      </ng-container>

      <button
        class="finish-btn"
        [disabled]="!isFormValid"
        [ngClass]="{ active: isFormValid }"
        (click)="finishSession()"
      >
        Finalizar Sesión
      </button>
    </div>
  </div>
</div>
