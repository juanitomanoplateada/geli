<div class="session-wrapper">
  <div class="header-section">
    <h1>Registrar Uso de Equipo / Patr√≥n</h1>

    <div class="dropdown-group">
      <app-dropdown-search
        [placeholder]="'Seleccione un laboratorio'"
        [options]="labNames"
        [selectedValue]="selectedLab"
        [disabled]="sessionActive"
        (select)="selectLab({ name: $event })"
      />

      <app-dropdown-search
        [placeholder]="'Seleccione un equipo / patr√≥n'"
        [options]="equipmentOptions"
        [selectedValue]="selectedEquipment"
        [disabled]="!selectedLab || sessionActive"
        (select)="selectEquipment($event)"
      />

      <button
        class="start-btn"
        [disabled]="!selectedLab || !selectedEquipment || sessionActive"
        (click)="onStartSessionClick()"
      >
        Iniciar Sesi√≥n
      </button>
    </div>
  </div>

  <app-confirm-modal
    [title]="'¬øConfirmar inicio de sesi√≥n?'"
    [show]="showConfirmationModal"
    (confirm)="confirmStartSession()"
    (cancel)="cancelStartSession()"
  >
    <p>
      Se va a registrar el uso del equipo
      <strong>{{ selectedEquipment }}</strong> en el laboratorio
      <strong>{{ selectedLab }}</strong
      >.
    </p>
  </app-confirm-modal>

  <div *ngIf="sessionActive" class="session-body">
    <div class="panel">
      <h2>Entrada</h2>

      <label>Fecha:<input type="text" [value]="checkIn.date" disabled /></label>
      <label>Hora:<input type="text" [value]="checkIn.time" disabled /></label>
      <label
        >Laboratorio:<input type="text" [value]="selectedLab" disabled
      /></label>
      <label
        >Equipo / Patr√≥n:<input
          type="text"
          [value]="selectedEquipment"
          disabled
      /></label>
      <label
        >Estado - Verificado:<input type="text" value="SI" disabled
      /></label>
      <label
        >Responsable:<input type="text" [value]="checkIn.user" disabled
      /></label>
    </div>

    <div class="panel">
      <h2>Salida</h2>

      <label>
        Estado - Para uso:
        <select
          [(ngModel)]="availabilityStatus"
          (change)="onAvailabilityChange()"
        >
          <option value="">Seleccione una opci√≥n</option>
          <option value="Yes">SI</option>
          <option value="No">NO</option>
        </select>
      </label>

      <ng-container *ngIf="availabilityStatus">
        <div *ngIf="availabilityStatus === 'No'" class="alert">
          Ingrese el motivo por el cual el equipo no est√° disponible en las
          observaciones.
        </div>

        <label
          >Tiempo de uso:<input type="text" [value]="usageDuration" readonly
        /></label>

        <label
          >Cantidad de muestras:
          <input
            type="number"
            [(ngModel)]="checkOut.sampleCount"
            appIntegerOnly
          />
        </label>

        <label>Funciones utilizadas:</label>
        <app-tag-selector
          [availableOptions]="availableFunctions"
          [selected]="selectedFunctions"
          (selectedChange)="selectedFunctions = $event"
          [placeholder]="'Buscar funciones...'"
        ></app-tag-selector>

        <label>
          Observaciones:
          <textarea
            [(ngModel)]="checkOut.remarks"
            (input)="autoResizeTextarea($event)"
          ></textarea>
        </label>
      </ng-container>

      <button
        class="finish-btn"
        [disabled]="!isFormValid"
        (click)="finishSession()"
      >
        Finalizar Sesi√≥n
      </button>

      <app-confirm-modal
        [title]="'¬øFinalizar sesi√≥n?'"
        [show]="showSummaryModal"
        [confirmLabel]="'Finalizar'"
        (confirm)="confirmFinishSession()"
        (cancel)="cancelFinishSession()"
      >
        <div class="summary-section">
          <h4>‚è± Detalles de uso</h4>
          <p><strong>Duraci√≥n:</strong> {{ usageDuration }}</p>
          <p><strong>Fecha:</strong> {{ checkIn.date }}</p>
          <p><strong>Hora de inicio:</strong> {{ checkIn.time }}</p>
        </div>

        <div class="summary-section">
          <h4>üî¨ Equipo utilizado</h4>
          <p><strong>Laboratorio:</strong> {{ selectedLab }}</p>
          <p><strong>Equipo / Patr√≥n:</strong> {{ selectedEquipment }}</p>
        </div>

        <div class="summary-section">
          <h4>üìä Datos de salida</h4>
          <p>
            <strong>Estado - Para uso:</strong>
            {{ availabilityStatus === "Yes" ? "SI" : "NO" }}
          </p>
          <p>
            <strong>Cantidad de muestras:</strong> {{ checkOut.sampleCount }}
          </p>
          <p><strong>Funciones utilizadas:</strong></p>
          <ul>
            <li *ngFor="let f of selectedFunctions"> {{ f }}</li>
          </ul>
          <p>
            <strong>Observaciones:</strong> {{ checkOut.remarks || "Ninguna" }}
          </p>
        </div>
      </app-confirm-modal>
    </div>
  </div>
</div>
