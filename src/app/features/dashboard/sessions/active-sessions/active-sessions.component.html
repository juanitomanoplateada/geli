<div *ngIf="isLoading" class="spinner-wrapper">
  <div class="spinner"></div>
  <p>Cargando datos, por favor espera...</p>
</div>

<div *ngIf="!isLoading" class="session-wrapper">
  <!-- Lista de sesiones y detalle -->
  <section class="session-section" *ngIf="activeSessions.length">
    <!-- Lista vertical -->
    <aside class="session-list-vertical">
      <h2>Sesiones Activas</h2>

      <button
        class="sort-btn"
        (click)="toggleSortOrder()"
        aria-label="Cambiar orden de sesiones"
      >
        <span class="sort-label">
          Ordenado por:
          {{ sessionSortDescending ? "M√°s recientes" : "M√°s antiguas" }}
          <span class="sort-icon">{{
            sessionSortDescending ? "‚¨áÔ∏è" : "‚¨ÜÔ∏è"
          }}</span>
        </span>
      </button>

      <div
        *ngFor="let s of activeSessions"
        class="session-card"
        [class.active]="s.id === selectedSessionId"
        (click)="selectSession(s.id)"
      >
        <strong>{{ s.equipment }}</strong>
        <p>{{ s.lab }}</p>
        <small>{{ s.checkIn.date }} - {{ s.checkIn.time }}</small>
      </div>
    </aside>

    <!-- Detalle de la sesi√≥n -->
    <div class="session-detail" *ngIf="selectedSession">
      <!-- Entrada -->
      <div class="panel entrada">
        <h2>Entrada</h2>
        <div class="field-row">
          <strong>Fecha:</strong> {{ selectedSession.checkIn.date }}
        </div>
        <div class="field-row">
          <strong>Hora:</strong> {{ selectedSession.checkIn.time }}
        </div>
        <div class="field-row">
          <strong>Nombre del Laboratorio:</strong> {{ selectedSession.lab }}
        </div>
        <div class="field-row">
          <strong>Ubicaci√≥n del Laboratorio:</strong>
          {{ selectedSession.labLocation }}
        </div>
        <div class="field-row">
          <strong>C√≥digo de Inventario:</strong>
          {{ selectedSession.equipmentInventoryNumber }}
        </div>
        <div class="field-row">
          <strong>Nombre del Equipo / Patr√≥n:</strong>
          {{ selectedSession.equipment }}
        </div>
        <div class="field-row">
          <strong>Responsable:</strong> {{ selectedSession.checkIn.user }}
        </div>
      </div>

      <!-- Salida -->
      <div class="panel salida">
        <h2>
          Salida
          <span
            *ngIf="selectedSession?.checkOut?.usageDuration"
            class="live-duration"
          >
            üïí {{ selectedSession.checkOut.usageDuration }}
          </span>
        </h2>

        <label>
          Estado - Verificado: <span class="required">*</span>
          <select [(ngModel)]="selectedSession.checkOut.verifiedStatus">
            <option value="">Seleccione una opci√≥n</option>
            <option value="YES">SI</option>
            <option value="NO">NO</option>
          </select>
        </label>

        <label>
          Estado - Para uso: <span class="required">*</span>
          <select
            [(ngModel)]="selectedSession.checkOut.usageStatus"
            (change)="onUsageStatusChange()"
          >
            <option value="">Seleccione una opci√≥n</option>
            <option value="YES">SI</option>
            <option value="NO">NO</option>
          </select>
        </label>

        <label>
          Cantidad de muestras: <span class="required">*</span>
          <input
            type="number"
            [(ngModel)]="selectedSession.checkOut.sampleCount"
            appIntegerOnly
          />
        </label>

        <label>Funciones utilizadas: <span class="required">*</span></label>
        <app-tag-selector
          [availableOptions]="selectedSession.availableFunctions"
          [selected]="selectedSession.checkOut.selectedFunctions"
          (selectedChange)="selectedSession.checkOut.selectedFunctions = $event"
          [labelField]="'functionName'"
          [valueField]="'id'"
        >
        </app-tag-selector>

        <label>
          Observaciones:
          <span
            *ngIf="selectedSession.checkOut.usageStatus === 'NO'"
            class="required"
            >*</span
          >
          <textarea
            [(ngModel)]="selectedSession.checkOut.remarks"
            (input)="autoResizeTextarea($event)"
          ></textarea>
        </label>

        <div
          *ngIf="selectedSession.checkOut.usageStatus === 'NO'"
          class="alert"
        >
          Por favor incluya en las observaciones los motivos por los cuales el
          equipo no est√° disponible para uso.
        </div>

        <button
          class="finish-btn"
          [disabled]="!isFormValid"
          (click)="finishSession()"
        >
          Finalizar Sesi√≥n
        </button>

        <!-- Modal Confirmar Finalizar -->
        <app-confirm-modal
          [title]="'¬øFinalizar sesi√≥n?'"
          [show]="showSummaryModal"
          [confirmLabel]="'Finalizar'"
          [isLoading]="isFinishingSession"
          (confirm)="confirmFinishSession()"
          (cancel)="cancelFinishSession()"
        >
          <div class="summary-section">
            <h4>‚è± Detalles de uso</h4>
            <p><strong>Fecha:</strong> {{ selectedSession.useDate }}</p>
            <p>
              <strong>Hora de inicio:</strong>
              {{ selectedSession.startUseTime }}
            </p>
            <p>
              <strong>Duraci√≥n:</strong>
              {{ selectedSession.checkOut.usageDuration }}
            </p>
          </div>

          <div class="summary-section">
            <h4>üî¨ Equipo utilizado</h4>
            <p><strong>Laboratorio:</strong> {{ selectedSession.labLabel }}</p>
            <p>
              <strong>Equipo / Patr√≥n:</strong>
              {{ selectedSession.equipmentLabel }}
            </p>
          </div>

          <div class="summary-section">
            <h4>üìä Datos de salida</h4>
            <p>
              <strong>Estado - Verificado:</strong>
              {{
                selectedSession.checkOut.verifiedStatus === "YES" ? "SI" : "NO"
              }}
            </p>
            <p>
              <strong>Estado - Para uso:</strong>
              {{ selectedSession.checkOut.usageStatus === "YES" ? "SI" : "NO" }}
            </p>
            <p>
              <strong>Cantidad de muestras:</strong>
              {{ selectedSession.checkOut.sampleCount }}
            </p>
            <p><strong>Funciones utilizadas:</strong></p>
            <ul>
              <li *ngFor="let f of selectedSession.checkOut.selectedFunctions">
                {{ f.functionName }}
              </li>
            </ul>
            <p>
              <strong>Observaciones:</strong>
              {{ selectedSession.checkOut.remarks || "Ninguna" }}
            </p>
          </div>

          <div *ngIf="finishSessionSuccess" class="feedback success">
            ‚úÖ Sesi√≥n finalizada exitosamente.
          </div>
          <div *ngIf="finishSessionError" class="feedback error">
            ‚ùå Error al finalizar la sesi√≥n. Intenta nuevamente.
          </div>
        </app-confirm-modal>
      </div>
    </div>
  </section>
</div>
