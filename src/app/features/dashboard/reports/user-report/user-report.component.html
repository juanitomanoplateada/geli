<div class="user-report-wrapper">
  <!-- Panel de exportación con título -->
  <div class="export-panel">
    <h1 class="report-title">📄 Reporte de Usuarios</h1>
    <div class="export-buttons">
      <button class="btn-excel" (click)="exportToExcel()">📊 Excel</button>
      <button class="btn-csv" (click)="exportToCSV()">📄 CSV</button>
      <button class="btn-pdf" (click)="onExportPDF()">🧾 PDF</button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="summary-panel filter-panel">
    <h3 class="section-title full-width">🔎 Filtros de Búsqueda</h3>

    <label>
      Estado:
      <select [(ngModel)]="selectedStatus" (change)="filterUsers()">
        <option value="">Todos</option>
        <option *ngFor="let status of statusOptions" [value]="status">
          {{ status }}
        </option>
      </select>
    </label>

    <label>
      Rol:
      <select [(ngModel)]="selectedRole" (change)="filterUsers()">
        <option value="">Todos</option>
        <option *ngFor="let role of roleOptions" [value]="role">
          {{ role }}
        </option>
      </select>
    </label>

    <label>
      Tipo de Fecha:
      <select [(ngModel)]="dateFilterType" (change)="filterUsers()">
        <option value="creation">Creación</option>
        <option value="modification">Modificación</option>
        <option value="assignment">Asignación</option>
      </select>
    </label>

    <label>
      Desde:
      <input type="date" [(ngModel)]="startDate" (change)="filterUsers()" />
    </label>

    <label>
      Hasta:
      <input type="date" [(ngModel)]="endDate" (change)="filterUsers()" />
    </label>

    <button (click)="resetFilters()">Limpiar Filtros</button>
  </div>

  <!-- Estadísticas -->
  <div class="summary-panel statistics-panel">
    <h3 class="section-title">📌 Estadísticas Generales</h3>

    <div class="stats-row">
      <div class="stat-box blue">
        <h4>🔵 Activos</h4>
        <p>{{ getChartValue(statusChart, 0) }}</p>
      </div>
      <div class="stat-box red">
        <h4>🔴 Inactivos</h4>
        <p>{{ getChartValue(statusChart, 1) }}</p>
      </div>
      <div class="stat-box neutral">
        <h4>📊 Total</h4>
        <p>{{ filteredUsers.length }}</p>
      </div>
      <div class="stat-box green">
        <h4>🧪 Analistas de Calidad</h4>
        <p>{{ getChartValue(roleChart, 0) }}</p>
      </div>
      <div class="stat-box gray">
        <h4>🛠️ Personal Autorizado</h4>
        <p>{{ getChartValue(roleChart, 1) }}</p>
      </div>
      <div class="stat-box neutral">
        <h4>📘 Total Roles</h4>
        <p>{{ getChartValue(roleChart, 0) + getChartValue(roleChart, 1) }}</p>
      </div>
    </div>

    <div class="stats-message">
      <p
        *ngIf="
          getChartValue(statusChart, 0) + getChartValue(statusChart, 1) ===
            filteredUsers.length &&
          getChartValue(roleChart, 0) + getChartValue(roleChart, 1) ===
            filteredUsers.length
        "
      >
        ✅ Los totales por estado y rol coinciden con el total de usuarios.
      </p>
      <p
        *ngIf="
          getChartValue(statusChart, 0) + getChartValue(statusChart, 1) !==
            filteredUsers.length ||
          getChartValue(roleChart, 0) + getChartValue(roleChart, 1) !==
            filteredUsers.length
        "
      >
        ⚠️ Revisa: hay discrepancia entre el total general y la suma por estado
        o rol.
      </p>
    </div>
  </div>

  <!-- Tabla y gráficas en una sola fila -->
  <div class="main-content">
    <!-- Tabla -->
    <div class="left-column">
      <div class="table-section">
        <h3 class="section-title">📋 Lista de Usuarios</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Identificación</th>
              <th>Estado</th>
              <th>Rol</th>
              <th>Creación</th>
              <th>Modificación</th>
              <th>Asignación</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td data-label="ID">{{ user.id }}</td>
              <td data-label="Nombre">{{ user.name }}</td>
              <td data-label="Identificación">{{ user.idNumber }}</td>
              <td data-label="Estado">{{ user.status }}</td>
              <td data-label="Rol">{{ user.role }}</td>
              <td data-label="Creación">
                {{ user.creationDate | date : "dd/MM/yyyy" }}
              </td>
              <td data-label="Modificación">
                {{ user.modificationDate | date : "dd/MM/yyyy" }}
              </td>
              <td data-label="Asignación">
                {{ user.assignmentDate | date : "dd/MM/yyyy" }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Gráficas -->
    <div class="right-column">
      <div class="chart-tabs">
        <h3 class="section-title">📈 Visualizaciones Gráficas</h3>
        <div class="tab-buttons">
          <button
            [class.active]="activeTab === 'status'"
            (click)="activeTab = 'status'"
          >
            Estado
          </button>
          <button
            [class.active]="activeTab === 'role'"
            (click)="activeTab = 'role'"
          >
            Rol
          </button>
          <button
            [class.active]="activeTab === 'creation'"
            (click)="activeTab = 'creation'"
          >
            Creación
          </button>
          <button
            [class.active]="activeTab === 'modification'"
            (click)="activeTab = 'modification'"
          >
            Modificación
          </button>
          <button
            [class.active]="activeTab === 'assignment'"
            (click)="activeTab = 'assignment'"
          >
            Asignación
          </button>
        </div>

        <div class="tab-content" *ngIf="isBrowser">
          <canvas
            baseChart
            [data]="statusChart"
            [type]="'bar'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'status'"
          ></canvas>
          <canvas
            baseChart
            [data]="roleChart"
            [type]="'pie'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'role'"
          ></canvas>
          <canvas
            baseChart
            [data]="creationChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'creation'"
          ></canvas>
          <canvas
            baseChart
            [data]="modificationChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'modification'"
          ></canvas>
          <canvas
            baseChart
            [data]="assignmentChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'assignment'"
          ></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
