<div class="user-report-wrapper">
  <!-- Panel de exportaciÃ³n con tÃ­tulo -->
  <div class="export-panel">
    <h1 class="report-title">ğŸ“„ Reporte de Usuarios</h1>
    <div class="export-buttons">
      <button class="btn-excel" (click)="exportToExcel()">ğŸ“Š Excel</button>
      <button class="btn-csv" (click)="exportToCSV()">ğŸ“„ CSV</button>
      <button class="btn-pdf" (click)="onExportPDF()">ğŸ§¾ PDF</button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="summary-panel filter-panel">
    <h3 class="section-title full-width">ğŸ” Filtros de BÃºsqueda</h3>

    <label>
      Estado:
      <select [(ngModel)]="selectedStatus" (change)="filterUsers()">
        <option value="">Todos</option>
        <option *ngFor="let status of statusOptions" [value]="status">
          {{ status }}
        </option>
      </select>
    </label>

    <label>
      Rol:
      <select [(ngModel)]="selectedRole" (change)="filterUsers()">
        <option value="">Todos</option>
        <option *ngFor="let role of roleOptions" [value]="role">
          {{ role }}
        </option>
      </select>
    </label>

    <label>
      Tipo de Fecha:
      <select [(ngModel)]="dateFilterType" (change)="filterUsers()">
        <option value="creation">CreaciÃ³n</option>
        <option value="modification">ModificaciÃ³n</option>
        <option value="assignment">AsignaciÃ³n</option>
      </select>
    </label>

    <label>
      Desde:
      <input type="date" [(ngModel)]="startDate" (change)="filterUsers()" />
    </label>

    <label>
      Hasta:
      <input type="date" [(ngModel)]="endDate" (change)="filterUsers()" />
    </label>

    <button (click)="resetFilters()">Limpiar Filtros</button>
  </div>

  <!-- EstadÃ­sticas -->
  <div class="summary-panel statistics-panel">
    <h3 class="section-title">ğŸ“Œ EstadÃ­sticas Generales</h3>

    <div class="stats-row">
      <div class="stat-box blue">
        <h4>ğŸ”µ Activos</h4>
        <p>{{ getChartValue(statusChart, 0) }}</p>
      </div>
      <div class="stat-box red">
        <h4>ğŸ”´ Inactivos</h4>
        <p>{{ getChartValue(statusChart, 1) }}</p>
      </div>
      <div class="stat-box neutral">
        <h4>ğŸ“Š Total</h4>
        <p>{{ filteredUsers.length }}</p>
      </div>
      <div class="stat-box green">
        <h4>ğŸ§ª Analistas de Calidad</h4>
        <p>{{ getChartValue(roleChart, 0) }}</p>
      </div>
      <div class="stat-box gray">
        <h4>ğŸ› ï¸ Personal Autorizado</h4>
        <p>{{ getChartValue(roleChart, 1) }}</p>
      </div>
      <div class="stat-box neutral">
        <h4>ğŸ“˜ Total Roles</h4>
        <p>{{ getChartValue(roleChart, 0) + getChartValue(roleChart, 1) }}</p>
      </div>
    </div>

    <div class="stats-message">
      <p
        *ngIf="
          getChartValue(statusChart, 0) + getChartValue(statusChart, 1) ===
            filteredUsers.length &&
          getChartValue(roleChart, 0) + getChartValue(roleChart, 1) ===
            filteredUsers.length
        "
      >
        âœ… Los totales por estado y rol coinciden con el total de usuarios.
      </p>
      <p
        *ngIf="
          getChartValue(statusChart, 0) + getChartValue(statusChart, 1) !==
            filteredUsers.length ||
          getChartValue(roleChart, 0) + getChartValue(roleChart, 1) !==
            filteredUsers.length
        "
      >
        âš ï¸ Revisa: hay discrepancia entre el total general y la suma por estado
        o rol.
      </p>
    </div>
  </div>

  <!-- Tabla y grÃ¡ficas en una sola fila -->
  <div class="main-content">
    <!-- Tabla -->
    <div class="left-column">
      <div class="table-section">
        <h3 class="section-title">ğŸ“‹ Lista de Usuarios</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>IdentificaciÃ³n</th>
              <th>Estado</th>
              <th>Rol</th>
              <th>CreaciÃ³n</th>
              <th>ModificaciÃ³n</th>
              <th>AsignaciÃ³n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td data-label="ID">{{ user.id }}</td>
              <td data-label="Nombre">{{ user.name }}</td>
              <td data-label="IdentificaciÃ³n">{{ user.idNumber }}</td>
              <td data-label="Estado">{{ user.status }}</td>
              <td data-label="Rol">{{ user.role }}</td>
              <td data-label="CreaciÃ³n">
                {{ user.creationDate | date : "dd/MM/yyyy" }}
              </td>
              <td data-label="ModificaciÃ³n">
                {{ user.modificationDate | date : "dd/MM/yyyy" }}
              </td>
              <td data-label="AsignaciÃ³n">
                {{ user.assignmentDate | date : "dd/MM/yyyy" }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- GrÃ¡ficas -->
    <div class="right-column">
      <div class="chart-tabs">
        <h3 class="section-title">ğŸ“ˆ Visualizaciones GrÃ¡ficas</h3>
        <div class="tab-buttons">
          <button
            [class.active]="activeTab === 'status'"
            (click)="activeTab = 'status'"
          >
            Estado
          </button>
          <button
            [class.active]="activeTab === 'role'"
            (click)="activeTab = 'role'"
          >
            Rol
          </button>
          <button
            [class.active]="activeTab === 'creation'"
            (click)="activeTab = 'creation'"
          >
            CreaciÃ³n
          </button>
          <button
            [class.active]="activeTab === 'modification'"
            (click)="activeTab = 'modification'"
          >
            ModificaciÃ³n
          </button>
          <button
            [class.active]="activeTab === 'assignment'"
            (click)="activeTab = 'assignment'"
          >
            AsignaciÃ³n
          </button>
        </div>

        <div class="tab-content" *ngIf="isBrowser">
          <canvas
            baseChart
            [data]="statusChart"
            [type]="'bar'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'status'"
          ></canvas>
          <canvas
            baseChart
            [data]="roleChart"
            [type]="'pie'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'role'"
          ></canvas>
          <canvas
            baseChart
            [data]="creationChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'creation'"
          ></canvas>
          <canvas
            baseChart
            [data]="modificationChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'modification'"
          ></canvas>
          <canvas
            baseChart
            [data]="assignmentChart"
            [type]="'line'"
            [legend]="true"
            class="chart"
            [class.hidden]="activeTab !== 'assignment'"
          ></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
