<div class="session-report-wrapper">
  <!-- Título -->
  <div class="header-panel">
    <h1 class="report-title">📋 Reporte de Sesiones de Uso de Equipos</h1>
    <div class="export-buttons">
      <button class="btn-excel" (click)="exportToExcel()">📊 Excel</button>
      <button class="btn-csv" (click)="exportToCSV()">📄 CSV</button>
      <button class="btn-pdf" (click)="exportToPDF()">🧾 PDF</button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="summary-panel filter-panel">
    <!-- Fila 1 -->
    <label>
      Fecha desde:
      <input
        type="date"
        [(ngModel)]="filters.dateFrom"
        (change)="filterSessions()"
        placeholder="aaaa-mm-dd"
      />
    </label>

    <label>
      Fecha hasta:
      <input
        type="date"
        [(ngModel)]="filters.dateTo"
        (change)="filterSessions()"
        placeholder="aaaa-mm-dd"
      />
    </label>

    <label>
      Hora desde:
      <input
        type="time"
        [(ngModel)]="filters.timeFrom"
        (change)="filterSessions()"
        placeholder="hh:mm"
      />
    </label>

    <label>
      Hora hasta:
      <input
        type="time"
        [(ngModel)]="filters.timeTo"
        (change)="filterSessions()"
        placeholder="hh:mm"
      />
    </label>

    <!-- Fila 2 - Dropdown laboratorio -->
    <label>
      Laboratorio:
      <app-dropdown-filter
        [options]="labOptions"
        [selected]="filters.lab"
        (selectedChange)="onLabChange($event)"
        placeholder="Seleccione laboratorio"
        allowEmpty="Todos"
      />
    </label>

    <!-- Dropdown equipo -->
    <label>
      Equipo / Patrón:
      <app-dropdown-filter
        [options]="equipmentOptions"
        [selected]="filters.equipment"
        (selectedChange)="onEquipmentChange($event)"
        placeholder="Seleccione equipo"
        allowEmpty="Todos"
      />
    </label>

    <!-- Dropdown responsable -->
    <label>
      Responsable:
      <app-dropdown-filter
        [options]="responsibleOptions"
        [selected]="filters.user"
        (selectedChange)="onUserChange($event)"
        placeholder="Seleccione responsable"
        allowEmpty="Todos"
      />
    </label>

    <!-- Verificado -->
    <label>
      Estado - Verificado:
      <select [(ngModel)]="filters.verifiedStatus" (change)="filterSessions()">
        <option value="">Todos</option>
        <option value="SI">Sí</option>
        <option value="NO">No</option>
      </select>
    </label>

    <!-- Para uso -->
    <label>
      Estado - Para uso:
      <select [(ngModel)]="filters.usageStatus" (change)="filterSessions()">
        <option value="">Todos</option>
        <option value="Disponible">Disponible</option>
        <option value="No disponible">No disponible</option>
      </select>
    </label>

    <!-- Tiempo de uso -->
    <label>
      Tiempo de uso desde (min):
      <input
        type="number"
        min="0"
        [(ngModel)]="filters.usageDurationMin"
        (change)="filterSessions()"
        placeholder="Mínimo"
      />
    </label>

    <label>
      Tiempo de uso hasta (min):
      <input
        type="number"
        min="0"
        [(ngModel)]="filters.usageDurationMax"
        (change)="filterSessions()"
        placeholder="Máximo"
      />
    </label>

    <!-- Muestras -->
    <label>
      Muestras desde:
      <input
        type="number"
        min="0"
        [(ngModel)]="filters.sampleCountMin"
        (change)="filterSessions()"
        placeholder="Mínimo"
      />
    </label>

    <label>
      Muestras hasta:
      <input
        type="number"
        min="0"
        [(ngModel)]="filters.sampleCountMax"
        (change)="filterSessions()"
        placeholder="Máximo"
      />
    </label>

    <!-- Función utilizada -->
    <label>
      Función utilizada:
      <app-dropdown-filter
        [options]="filteredFunctions"
        [selected]="filters.function"
        (selectedChange)="onFunctionChange($event)"
        placeholder="Seleccione función"
        allowEmpty="Todas"
      />
    </label>

    <!-- Botones -->
    <button (click)="resetFilters()">Limpiar Filtros</button>
  </div>

  <!-- Estadísticas -->
  <div class="summary-panel statistics-panel">
    <h3 class="section-title">📌 Estadísticas Generales</h3>
    <div class="stats-row">
      <div class="stat-box neutral">
        <h4>📦 Total de Sesiones</h4>
        <p>{{ filteredSessions.length }}</p>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-panel">
    <h3 class="section-title">📄 Lista de Sesiones</h3>
    <div class="table-section">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Laboratorio</th>
            <th>Equipo</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Verificado</th>
            <th>Responsable</th>
            <th>Correo</th>
            <th>Estado para uso</th>
            <th>Minutos</th>
            <th>Muestras</th>
            <th>Funciones</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of filteredSessions">
            <td data-label="ID">{{ s.id }}</td>
            <td data-label="Laboratorio">{{ s.lab }}</td>
            <td data-label="Equipo">{{ s.equipment }}</td>
            <td data-label="Fecha">{{ s.date }}</td>
            <td data-label="Hora">{{ s.time }}</td>
            <td data-label="Verificado">{{ s.verifiedStatus }}</td>
            <td data-label="Responsable">{{ s.responsible }}</td>
            <td data-label="Correo">{{ s.email }}</td>
            <td data-label="Estado">{{ s.usageStatus }}</td>
            <td data-label="Minutos">{{ s.usageDuration }}</td>
            <td data-label="Muestras">{{ s.sampleCount }}</td>
            <td data-label="Funciones">{{ s.functionsUsed?.join(", ") }}</td>
            <td data-label="Observaciones">{{ s.observations }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 📊 Gráficas -->
  <div class="chart-panel">
    <h3 class="section-title">📈 Visualizaciones Gráficas</h3>

    <div class="chart-tabs">
      <div class="tab-buttons">
        <button
          [class.active]="activeTab === 'date'"
          (click)="activeTab = 'date'"
        >
          Fecha
        </button>
        <button
          [class.active]="activeTab === 'time'"
          (click)="activeTab = 'time'"
        >
          Hora
        </button>
        <button
          [class.active]="activeTab === 'verified'"
          (click)="activeTab = 'verified'"
        >
          Verificado
        </button>
        <button
          [class.active]="activeTab === 'usage'"
          (click)="activeTab = 'usage'"
        >
          Tiempo de Uso
        </button>
        <button
          [class.active]="activeTab === 'samples'"
          (click)="activeTab = 'samples'"
        >
          Muestras
        </button>
        <button
          [class.active]="activeTab === 'functions'"
          (click)="activeTab = 'functions'"
        >
          Funciones Usadas
        </button>
        <button
          [class.active]="activeTab === 'lab'"
          (click)="activeTab = 'lab'"
        >
          Laboratorio
        </button>
        <button
          [class.active]="activeTab === 'equipment'"
          (click)="activeTab = 'equipment'"
        >
          Equipo
        </button>
        <button
          [class.active]="activeTab === 'usageStatus'"
          (click)="activeTab = 'usageStatus'"
        >
          Estado para uso
        </button>
        <button
          [class.active]="activeTab === 'responsible'"
          (click)="activeTab = 'responsible'"
        >
          Responsable
        </button>
      </div>

      <div class="tab-content" *ngIf="isBrowser">
        <canvas
          *ngIf="activeTab === 'date'"
          baseChart
          [data]="dateChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'time'"
          baseChart
          [data]="timeChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'verified'"
          baseChart
          [data]="verifiedChart"
          [type]="'pie'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'usage'"
          baseChart
          [data]="usageChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'samples'"
          baseChart
          [data]="samplesChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'functions'"
          baseChart
          [data]="functionsChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'lab'"
          baseChart
          [data]="labChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'equipment'"
          baseChart
          [data]="equipmentChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'usageStatus'"
          baseChart
          [data]="usageStatusChart"
          [type]="'pie'"
          class="chart"
        ></canvas>
        <canvas
          *ngIf="activeTab === 'responsible'"
          baseChart
          [data]="responsibleChart"
          [type]="'bar'"
          class="chart"
        ></canvas>
      </div>
    </div>
  </div>
</div>
