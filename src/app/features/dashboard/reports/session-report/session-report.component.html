<div class="session-report-container">
  <h1>Reporte de Sesiones</h1>

  <!-- üéØ Filtros avanzados din√°micos -->
  <app-search-filter-only
    [isLoading]="isLoading"
    [fieldsConfig]="fieldsConfig"
    [filters]="filters"
    [options]="{
      lab: availableLabs,
      equipment: availableEquipments,
      function: availableFunctions,
      user: availableUsers
    }"
    [availableFilterKeys]="availableFilterKeys"
    [activeFilterKeys]="activeFilterKeys"
    (filtersChange)="onFiltersChange($event)"
    (activeFilterKeysChange)="activeFilterKeys = $event"
    (clearFilters)="clearFilters()"
  ></app-search-filter-only>

  <!-- ‚è≥ Estado de carga -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando sesiones...</p>
  </div>

  <h1>Estad√≠sticas Generales</h1>

  <!-- üìä Estad√≠sticas -->
  <div *ngIf="!isLoading" class="stats-boxes">
    <div class="stat-box info">
      <h4>Total de Sesiones</h4>
      <p>{{ sessionRecords.length }}</p>
    </div>
    <div class="stat-box success">
      <h4>Sesiones Activas</h4>
      <p>{{ usageData[1] }}</p>
    </div>
    <div class="stat-box warning">
      <h4>Sesiones Finalizadas</h4>
      <p>{{ usageData[0] }}</p>
    </div>
  </div>

  <h1>Gr√°ficas</h1>

  <!-- üóÇ Pesta√±as -->
  <div class="tab-buttons">
    <button
      [class.active]="activeTab === 'usuario'"
      (click)="activeTab = 'usuario'"
    >
      Frecuencia por Responsable ({{ getTotal(userData) }})
    </button>

    <button
      [class.active]="activeTab === 'laboratorio'"
      (click)="activeTab = 'laboratorio'"
    >
      Frecuencia por Laboratorio ({{ getTotal(laboratoryData) }})
    </button>

    <button
      [class.active]="activeTab === 'equipo'"
      (click)="activeTab = 'equipo'"
    >
      Frecuencia por Equipo ({{ getTotal(equipmentData) }})
    </button>

    <button
      [class.active]="activeTab === 'funcion'"
      (click)="activeTab = 'funcion'"
    >
      Frecuencia por Funci√≥n ({{ getTotal(functionData) }})
    </button>

    <button
      [class.active]="activeTab === 'muestras'"
      (click)="activeTab = 'muestras'"
    >
      Cantidad de Muestras ({{ getTotal(sampleRangeData) }})
    </button>

    <button [class.active]="activeTab === 'hora'" (click)="activeTab = 'hora'">
      Sesiones por Hora ({{ getTotal(sessionHourData) }})
    </button>

    <button
      [class.active]="activeTab === 'historico'"
      (click)="activeTab = 'historico'"
    >
      Historial de Sesiones ({{ sessionStartDates.length }})
    </button>

    <button
      [class.active]="activeTab === 'estado'"
      (click)="activeTab = 'estado'"
    >
      Estado de Uso ({{ getTotal(usageData) }})
    </button>
    <button
      [class.active]="activeTab === 'verificado'"
      (click)="activeTab = 'verificado'"
    >
      Estado Verificado ({{ getTotal(verifiedData) }})
    </button>
    <button
      [class.active]="activeTab === 'paraUso'"
      (click)="activeTab = 'paraUso'"
    >
      Estado Para Uso ({{ getTotal(usageData) }})
    </button>
  </div>

  <!-- üìà Gr√°ficas -->
  <div *ngIf="!isLoading" class="chart-box">
    <h4 *ngIf="activeTab === 'usuario'">Frecuencia por Responsable</h4>
    <canvas
      *ngIf="activeTab === 'usuario'"
      baseChart
      [data]="userUsageChart.data"
      [type]="userUsageChart.type"
      [options]="userUsageChart.options"
    ></canvas>

    <h4 *ngIf="activeTab === 'estado'">Distribuci√≥n de Estado de Uso</h4>
    <canvas
      *ngIf="activeTab === 'estado'"
      baseChart
      [data]="{ labels: usageLabels, datasets: [{ data: usageData }] }"
      [type]="'pie'"
      [options]="{ responsive: true, maintainAspectRatio: false }"
    ></canvas>

    <h4 *ngIf="activeTab === 'historico'">Hist√≥rico de Inicio de Sesiones</h4>
    <canvas
      *ngIf="activeTab === 'historico'"
      baseChart
      [data]="sessionTimelineChart.data"
      [type]="sessionTimelineChart.type"
      [options]="sessionTimelineChart.options"
    ></canvas>

    <h4 *ngIf="activeTab === 'hora'">Sesiones por Hora del D√≠a</h4>
    <canvas
      *ngIf="activeTab === 'hora'"
      baseChart
      [data]="sessionsByHourChart.data"
      [type]="sessionsByHourChart.type"
      [options]="sessionsByHourChart.options"
    ></canvas>

    <h4 *ngIf="activeTab === 'laboratorio'">Frecuencia por Laboratorio</h4>
    <canvas
      *ngIf="activeTab === 'laboratorio'"
      baseChart
      [data]="labUsageChart.data"
      [type]="labUsageChart.type"
      [options]="labUsageChart.options"
    ></canvas>

    <h4 *ngIf="activeTab === 'equipo'">Frecuencia por Equipo</h4>
    <canvas
      *ngIf="activeTab === 'equipo'"
      baseChart
      [data]="equipmentUsageChart.data"
      [type]="equipmentUsageChart.type"
      [options]="equipmentUsageChart.options"
    ></canvas>

    <h4 *ngIf="activeTab === 'funcion'">Frecuencia por Funci√≥n</h4>
    <canvas
      *ngIf="activeTab === 'funcion'"
      baseChart
      [data]="functionUsageChart.data"
      [type]="functionUsageChart.type"
      [options]="functionUsageChart.options"
    ></canvas>
    <h4 *ngIf="activeTab === 'verificado'">
      Distribuci√≥n de Estado Verificado
    </h4>
    <canvas
      *ngIf="activeTab === 'verificado'"
      baseChart
      [data]="verifiedStatusChart.data"
      [type]="verifiedStatusChart.type"
      [options]="verifiedStatusChart.options"
    ></canvas>
    <h4 *ngIf="activeTab === 'paraUso'">Distribuci√≥n de Estado Para Uso</h4>
    <canvas
      *ngIf="activeTab === 'paraUso'"
      baseChart
      [data]="usageStatusChart.data"
      [type]="usageStatusChart.type"
      [options]="usageStatusChart.options"
    ></canvas>
    <h4 *ngIf="activeTab === 'muestras'">
      Distribuci√≥n por Cantidad de Muestras
    </h4>
    <canvas
      *ngIf="activeTab === 'muestras'"
      baseChart
      [data]="samplesChart.data"
      [type]="samplesChart.type"
      [options]="samplesChart.options"
    ></canvas>
  </div>
</div>
