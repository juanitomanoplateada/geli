<div class="assign-equipment-permissions">
  <h1>Asignar Permisos de Uso de Equipos</h1>

  <!-- Selección de usuario -->
  <div class="user-select-section">
    <label for="user">Seleccione un usuario</label>
    <app-dropdown-search
      [options]="userOptions"
      [selectedValue]="selectedUser ? getUserLabel(selectedUser) : null"
      (select)="onUserSelect($event)"
      placeholder="Buscar usuario..."
    ></app-dropdown-search>
  </div>

  <!-- Panel de equipos autorizados (siempre visible cuando hay usuario) -->
  <div *ngIf="selectedUser" class="permissions-summary">
    <h3>Equipos autorizados para {{ getUserLabel(selectedUser) }}</h3>
    <ng-container *ngIf="authorizedEquipments.length > 0; else noEquipos">
      <ul>
        <li *ngFor="let eq of authorizedEquipments">
          {{ eq.equipmentName }} ({{ eq.inventoryNumber }})
        </li>
      </ul>
    </ng-container>
    <ng-template #noEquipos>
      <p>No se ha seleccionado ningún equipo.</p>
    </ng-template>

    <button (click)="savePermissions()" class="save-btn">
      Guardar cambios
    </button>
  </div>

  <!-- Filtros y búsqueda -->
  <app-search-advanced
    *ngIf="selectedUser"
    [searchQuery]="searchQuery"
    [filters]="filters"
    [isLoading]="isLoading"
    [showAdvancedSearch]="showAdvancedSearch"
    [fieldsConfig]="fieldsConfig"
    [options]="options"
    [availableFilterKeys]="availableFilterKeys"
    [activeFilterKeys]="activeFilterKeys"
    (searchQueryChange)="searchQuery = $event"
    (filtersChange)="onFiltersChange($event)"
    (activeFilterKeysChange)="activeFilterKeys = $event"
    (triggerSearch)="performSearch()"
    (clearFilters)="resetSearch()"
    (toggleAdvanced)="toggleAdvancedSearch()"
  ></app-search-advanced>

  <!-- Tabla con checkbox por equipo -->
  <app-results-table-checkbox
    *ngIf="!isLoading && equipmentResults.length > 0"
    [columns]="columns"
    [data]="equipmentResults"
    [checkedItems]="authorizedEquipments"
    (checkedItemsChange)="updateAuthorizedEquipments($event)"
  ></app-results-table-checkbox>

  <!-- Sin resultados -->
  <div
    *ngIf="hasSearched && !isLoading && equipmentResults.length === 0"
    class="no-results"
  >
    <p>No se encontraron equipos con los filtros actuales.</p>
    <button (click)="resetSearch()" class="try-again-btn">
      Limpiar búsqueda
    </button>
  </div>

  <!-- Modal de confirmación -->
  <app-confirm-modal
    [show]="showConfirmModal"
    [title]="'¿Confirmar cambios de permisos?'"
    [confirmLabel]="'Confirmar'"
    [cancelLabel]="'Cancelar'"
    [isLoading]="isModalProcessing"
    (confirm)="confirmSave()"
    (cancel)="cancelSave()"
  >
    <p>
      Se asignarán los siguientes
      <strong>{{ authorizedEquipments.length }}</strong> equipos al usuario
      <strong>{{ selectedUser?.firstName }} {{ selectedUser?.lastName }}</strong
      >:
    </p>
    <ul>
      <li *ngFor="let eq of authorizedEquipments">
        {{ eq.equipmentName }} ({{ eq.inventoryNumber }})
      </li>
    </ul>
    <ng-container *ngIf="modalSuccessMessage">
      <p class="modal-feedback">{{ modalSuccessMessage }}</p>
    </ng-container>
  </app-confirm-modal>
</div>
